<!DOCTYPE html>
<meta charset="utf-8" />

<head>
    <script src="http://d3js.org/d3.v7.js"></script>
    <style></style>
</head>

<body>
    <div id="controls">
        <form>
            <group>
                <input
                    type="radio"
                    id="r_effort"
                    name="sizer"
                    value="effort"
                    onclick="sizeByEffort();"
                />
                Size by effort
                <input
                    type="radio"
                    id="r_risk"
                    name="sizer"
                    value="risk"
                    onclick="sizeByRisk();"
                />
                Size by risk
            </group>
        </form>
    </div>

    <!-- inline-block -->
    <div id="circlechart" style="display: inline-block; width: 50%"></div>

    <script>
        const category_to_index = {
            Security: 1,
            Operations: 2,
            Maintainability: 3,
        };

        var data = [];

        // d3 load data.csv
        d3.csv("data.csv", (d) => {
            console.log("loading", d);
            return {
                name: d.name,
                code: d.code,
                category: d.category,
                categoryId: category_to_index[d.category] || 0,
                effort: +d.effort,
                risk: +d.risk,
                radius: 8 * Math.sqrt(d.effort) + 10,
            };
        }).then(function (ds) {
            data = ds;
            draw(ds);
        });

        var simulation = d3.forceSimulation();


        // set the dimensions and margins of the graph
        var width = window.innerWidth / 2;
        var height = window.innerHeight;

        // append the svg object to the body of the page
        var svg = d3
            .select("#circlechart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        // A scale that gives a X target position for each group
        var x = d3
            .scaleOrdinal()
            .domain(["Security", "Operations", "Maintainability"])
            .range([width / 4, width / 2, (3 * width) / 4]);

        // A color scale
        var color = d3
            .scaleOrdinal()
            .domain(["Security", "Operations", "Maintainability"])
            .range(["#F8766D", "#00BA38", "#619CFF"]);

        // Initialize the circle: all located at the center of the svg area
        var gs = svg
            .append("g")

        function draw(data) {
                gs = gs.selectAll("circle")
                .data(data)
                .enter()
                .append("g");

            gs.attr("translate", `transform(${width / 2}, ${height / 2})`)
                .on("click", clicked)
                .call(
                    d3
                        .drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended)
                );

            gs.append("circle")
                .attr("r", (d) => d.radius)
                .attr("cx", 0)
                .attr("cy", 0)
                .style("fill", (d) => color(d.category))
                .style("fill-opacity", 0.8)
                .attr("stroke", "black")
                .style("stroke-width", 4);

            gs.append("text")
                .attr("dx", -10)
                .attr("dy", ".35em")
                .text((d) => d.code);

            // Features of the forces applied to the nodes:
            simulation
                .force(
                    "x",
                    d3
                        .forceX()
                        .strength(0.5)
                        .x((d) => x(d.category))
                )
                .force(
                    "y",
                    d3
                        .forceY()
                        .strength(0.1)
                        .y(height / 2)
                )
                .force(
                    "center",
                    d3
                        .forceCenter()
                        .x(width / 2)
                        .y(height / 2)
                ) // Attraction to the center of the svg area
                .force("charge", d3.forceManyBody().strength(1)); // Nodes are attracted one each other of value is > 0

            updateRadius();

            // Apply these forces to the nodes and update their positions.
            // Once the force algorithm is happy with positions ('alpha' value is low enough), simulations will stop.
            simulation.nodes(data).on("tick", (d) => {
                gs.attr("transform", (d) => `translate(${d.x}, ${d.y})`);
            });
        }

        function updateRadius() {
            gs.select("circle").attr("r", (d) => d.radius);

            // Force that avoids circle overlapping
            simulation.force(
                "collide",
                d3
                    .forceCollide()
                    .strength(0.1)
                    .radius((d) => d.radius * 1.2)
                    .iterations(1)
            );
        }

        function clicked(event, d) {
            if (event.defaultPrevented) return; // dragged

            d3.select(this)
                .select("circle")
                .transition()
                .attr("fill", "black")
                .attr("r", (d) => d.radius * 2)
                .transition()
                .attr("r", (d) => d.radius)
                .attr("fill", d3.schemeCategory10[d.categoryId]);

            updateInfoCard(d);
        }

        function dragstarted() {
            simulation.alphaTarget(0.03).restart();
        }

        function dragged(event, d) {
            d3.select(this)
                .raise()
                .attr("cx", (d.x = event.x))
                .attr("cy", (d.y = event.y));
        }

        function dragended() {
            simulation.alphaTarget(0.03).restart();
        }

        function updateInfoCard(d) {
            document.getElementById("detail").innerHTML = `
                <h1>${d.name}</h1>
                <h2>What is the purpose?</h2>
                <p class="note">What is this and why is it important?</p>
                <h2>Does this apply to us?</h2>
                <p class="note">How can a team determine that this tools is important/required for their product?  At what point(s) in the product's lifecycle should it be used and how often?  examples: in all CI/CD pipelines, for all cloud software, if your software is hosted on VMs, if you are using docker containers, before delivering new software to customer facing environments, when making significant software changes
                </p>
                <h2>What's the risk if we don't use it?</h2>
                <p class="note">Consider the risk and who is impacted.  The team, our customers, Iress?</p>
                <h2>How long will it take us?</h2>
                <p class="note">Consider setup / first time use, including any knowledge aquisition, as well as ongoing or regular use.</p>
                <p>Category: ${d.category}</p>
                <p>Effort: ${d.effort}</p>
            `;
        }

        function sizeByEffort() {
            for (d of data) {
                d.radius = 8 * Math.sqrt(d.effort) + 10;
            }
            updateRadius();
            simulation.alphaTarget(0.03).restart();
        }

        function sizeByRisk() {
            for (d of data) {
                d.radius = d.risk * 10 + 10;
            }
            updateRadius();
            simulation.alphaTarget(0.03).restart();
        }
    </script>

    <!-- the detail div occupies the right-hand half of the page -->
    <div style="float: right; width: 50%" id="detail">
        (Click a node for detail)
    </div>
</body>
